name: Deploy Bronze Layer

on:
  push:
    branches: [ main ]

jobs:
  deploy-bronze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Snowflake Python Connector
        run: |
          pip install snowflake-connector-python

      - name: Execute Bronze SQL via Python
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}

        run: |
          python <<EOF
          import snowflake.connector

          conn = snowflake.connector.connect(
              user="$SNOWFLAKE_USER",
              password="$SNOWFLAKE_PASSWORD",
              account="$SNOWFLAKE_ACCOUNT",
              role="SYSADMIN",
              warehouse="COMPUTE_WH"
          )

          cursor = conn.cursor()

          with open("sql/01_bronze.sql", "r") as f:
              sql_commands = f.read().split(";")

          for command in sql_commands:
              if command.strip():
                  cursor.execute(command)

          print("Bronze layer executed successfully.")

          cursor.close()
          conn.close()
          EOF